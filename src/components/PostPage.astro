---
import type { CollectionEntry } from "astro:content";
import type { Page } from "astro";
import { siteConfig } from "../config";
import { widgetManager } from "../utils/widget-manager";
import PostCard from "./PostCard.astro";

interface Props {
	page: Page<CollectionEntry<"posts">>;
}

const { page } = Astro.props;

// 检查是否启用右侧边栏（通过检查右侧是否有组件）
const hasRightSidebars =
	widgetManager.getComponentsByPosition("top", "right", "desktop").length > 0 ||
	widgetManager.getComponentsByPosition("sticky", "right", "desktop").length > 0;

// 根据配置设置初始布局模式
const defaultLayout = siteConfig.postListLayout.defaultMode || "list";
const initialLayoutClass = defaultLayout === "grid" ? "grid-mode" : "list-mode";
---

<div
	id="post-list-container"
	class={`transition-all duration-500 ease-in-out rounded-[var(--radius-large)] bg-[var(--card-bg)] md:bg-transparent mb-4 ${initialLayoutClass}`}
	data-default-layout={defaultLayout}
	data-both-sidebars={hasRightSidebars}
>
	{
		page.data.map((entry, index) => (
			<PostCard
				entry={entry}
				class:list="onload-animation"
				style={`--i: ${index}; --interval: 50ms;`}
			/>
		))
	}
</div>

<script>
	// 动态布局切换脚本
	function initLayout() {
		requestAnimationFrame(() => {
			const postListContainer = document.getElementById(
				"post-list-container",
			);
			if (!postListContainer) return;

			// 读取偏好
			const savedLayout = localStorage.getItem("postListLayout");
			const defaultLayout =
				postListContainer.getAttribute("data-default-layout") || "list";
			const currentLayout = savedLayout || defaultLayout;

			// 检查现有状态是否一致，避免重复初始化
			const hasGridClass =
				postListContainer.classList.contains("grid-mode");
			const isClassCorrect =
				(currentLayout === "grid" && hasGridClass) ||
				(currentLayout === "list" && !hasGridClass);

			if (isClassCorrect) {
				postListContainer.classList.add("js-initialized");
				publishLayoutInit();
				return;
			}

			// 桌面端执行布局更新，移动端由 CSS 处理
			if (window.innerWidth >= 769) {
				updatePostListLayout(currentLayout);
			} else {
				postListContainer.classList.add("js-initialized");
			}

			publishLayoutInit();
		});
	}

	function updatePostListLayout(layout: string) {
		const container = document.getElementById("post-list-container");
		if (!container) return;

		container.classList.add("layout-switching");

		// 切换布局模式类名
		if (layout === "grid") {
			container.classList.remove("list-mode");
			container.classList.add("grid-mode");

			// Grid 模式下隐藏右侧栏
			const rightSidebar = document.querySelector(
				".right-sidebar-container",
			);
			if (rightSidebar) rightSidebar.classList.add("hidden-in-grid-mode");

			const mainGrid = document.getElementById("main-grid");
			if (mainGrid) mainGrid.setAttribute("data-layout-mode", "grid");
		} else {
			container.classList.remove("grid-mode");
			container.classList.add("list-mode");

			// List 模式下显示右侧栏
			const rightSidebar = document.querySelector(
				".right-sidebar-container",
			);
			if (rightSidebar)
				rightSidebar.classList.remove("hidden-in-grid-mode");

			const mainGrid = document.getElementById("main-grid");
			if (mainGrid) mainGrid.setAttribute("data-layout-mode", "list");
		}

		container.classList.add("js-initialized");

		// 移除切换动画类
		setTimeout(() => {
			container.classList.remove("layout-switching");
		}, 500);
	}

	// 监听布局变化
	window.addEventListener("layoutChange", (event: any) => {
		if (event.detail?.layout) updatePostListLayout(event.detail.layout);
	});

	// Resize 防抖
	let resizeTimeout: number | undefined;
	window.addEventListener("resize", () => {
		clearTimeout(resizeTimeout);
		resizeTimeout = window.setTimeout(() => {
			if (window.innerWidth >= 769) {
				const savedLayout = localStorage.getItem("postListLayout");
				const defaultLayout =
					document
						.getElementById("post-list-container")
						?.getAttribute("data-default-layout") || "list";
				updatePostListLayout(savedLayout || defaultLayout);
			}
		}, 100);
	});

	// 初始化
	document.addEventListener("DOMContentLoaded", initLayout);
	if (document.readyState !== "loading") initLayout();

	// Swup 集成
	function setupSwupListeners() {
		if ((window as any)._postListSwupListenerAttached) return;

		function trySetupSwup() {
			if (typeof window !== "undefined" && (window as any).swup) {
				(window as any).swup.hooks.on("content:replace", initLayout);
				(window as any)._postListSwupListenerAttached = true;
				return true;
			}
			return false;
		}

		if (!trySetupSwup()) {
			let retryCount = 0;
			const retryInterval = setInterval(() => {
				if (trySetupSwup() || ++retryCount >= 10) {
					clearInterval(retryInterval);
					if (retryCount >= 10) {
						window.addEventListener("popstate", () =>
							requestAnimationFrame(initLayout),
						);
					}
				}
			}, 100);
		}
	}
	setTimeout(setupSwupListeners, 200);

	function publishLayoutInit() {
		const container = document.getElementById("post-list-container");
		if (container) {
			const layout = container.classList.contains("grid-mode")
				? "grid"
				: "list";
			window.dispatchEvent(
				new CustomEvent("layoutInit", { detail: { layout } }),
			);
		}
	}
	setTimeout(publishLayoutInit, 150);
</script>

<script>
	function normalizePostPreviewLang(raw: string | null | undefined) {
		if (!raw) return "";
		const normalized = String(raw).trim().toLowerCase().replace(/-/g, "_");
		if (normalized === "jp" || normalized === "ja_jp") return "ja";
		if (
			normalized === "en_us" ||
			normalized === "en_gb" ||
			normalized === "en_au"
		)
			return "en";
		if (
			normalized === "cn" ||
			normalized === "zh_hans" ||
			normalized === "zh_sg"
		)
			return "zh_cn";
		if (
			normalized === "tw" ||
			normalized === "zh_hant" ||
			normalized === "zh_hk" ||
			normalized === "zh_mo"
		)
			return "zh_tw";
		return normalized;
	}

	function getPostPreviewBrowserLangCandidates() {
		const rawList =
			Array.isArray(navigator.languages) && navigator.languages.length > 0
				? navigator.languages
				: navigator.language
					? [navigator.language]
					: [];
		const result: string[] = [];

		for (const raw of rawList) {
			const normalized = normalizePostPreviewLang(raw);
			if (!normalized) continue;
			if (!result.includes(normalized)) result.push(normalized);
			const base = normalized.split("_")[0];
			if (base && !result.includes(base)) result.push(base);
		}

		return result;
	}

	function applyLocalizedPostPreviews() {
		const cards = document.querySelectorAll<HTMLElement>(
			"#post-list-container [data-post-preview-variants]",
		);
		if (!cards.length) return;

		const candidates = getPostPreviewBrowserLangCandidates();

		for (const card of cards) {
			const raw = card.dataset.postPreviewVariants;
			if (!raw) continue;

			let variants: Array<{
				lang?: string;
				title?: string;
				description?: string;
			}> = [];
			try {
				variants = JSON.parse(raw);
			} catch {
				continue;
			}
			if (!Array.isArray(variants) || variants.length <= 1) continue;

			const byLang = new Map<string, (typeof variants)[number]>();
			let defaultVariant: (typeof variants)[number] | null = null;

			for (const variant of variants) {
				const lang = normalizePostPreviewLang(variant.lang || "") || "default";
				if (!byLang.has(lang)) byLang.set(lang, variant);
				const base = lang.split("_")[0];
				if (base && !byLang.has(base)) byLang.set(base, variant);
				if (lang === "default" && !defaultVariant) defaultVariant = variant;
			}

			let target =
				candidates.map((lang) => byLang.get(lang)).find(Boolean) ||
				defaultVariant ||
				variants[0];
			if (!target) continue;

			const titleEl = card.querySelector<HTMLElement>("[data-post-preview-title]");
			if (titleEl && typeof target.title === "string" && target.title.length > 0) {
				titleEl.textContent = target.title;
			}

			const descEl = card.querySelector<HTMLElement>(
				"[data-post-preview-description]",
			);
			if (
				descEl &&
				typeof target.description === "string" &&
				target.description.length > 0
			) {
				descEl.textContent = target.description;
			}

			const links = card.querySelectorAll<HTMLAnchorElement>(
				"[data-post-preview-title-link], [data-post-preview-cover-link]",
			);
			for (const link of links) {
				if (typeof target.title === "string" && target.title.length > 0) {
					link.setAttribute("aria-label", target.title);
					link.setAttribute("title", target.title);
				}
			}
		}
	}

	document.addEventListener("DOMContentLoaded", applyLocalizedPostPreviews);
	if (document.readyState !== "loading") applyLocalizedPostPreviews();

	function setupLocalizedPreviewSwupListeners() {
		if ((window as any)._localizedPostPreviewSwupBound) return;

		function tryBind() {
			if (typeof window !== "undefined" && (window as any).swup) {
				(window as any).swup.hooks.on(
					"content:replace",
					() => requestAnimationFrame(applyLocalizedPostPreviews),
				);
				(window as any)._localizedPostPreviewSwupBound = true;
				return true;
			}
			return false;
		}

		if (!tryBind()) {
			let retryCount = 0;
			const retryInterval = setInterval(() => {
				if (tryBind() || ++retryCount >= 10) {
					clearInterval(retryInterval);
				}
			}, 100);
		}
	}

	setTimeout(setupLocalizedPreviewSwupListeners, 200);
</script>

<style>
	/* 基础容器 */
	#post-list-container {
		min-height: 200px;
		transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
	}

	/* 布局模式 - 列表模式 */
	#post-list-container.list-mode {
		@apply flex flex-col gap-4;
	}

	/* 布局模式 - 网格模式 (仅在桌面端生效，移动端强制单列) */
	#post-list-container.grid-mode {
		@apply grid grid-cols-1 md:grid-cols-2 gap-6;
	}

	/* 内容可见性 (视口外不渲染) */
	#post-list-container > :global(*) {
		content-visibility: auto;
		contain-intrinsic-size: 200px;
		transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
		opacity: 0;
		animation: fadeInSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
		animation-delay: calc(
			var(--content-delay) + var(--i) * var(--interval)
		);
	}

	/* 网格模式动画调整 */
	#post-list-container.grid-mode > :global(*) {
		animation-name: fadeInScale;
	}

	/* 布局切换时的过渡状态 */
	#post-list-container.layout-switching {
		opacity: 0.95;
	}

	#post-list-container.layout-switching > :global(*) {
		animation-delay: calc(var(--i) * 50ms);
	}

	#post-list-container.layout-switching > :global(*) {
		transform: scale(0.98);
	}

	@keyframes fadeInScale {
		from {
			opacity: 0;
			transform: scale(0.95);
		}
		to {
			opacity: 1;
			transform: scale(1);
		}
	}

	@keyframes fadeInSlide {
		from {
			opacity: 0;
			transform: translateX(-10px);
		}
		to {
			opacity: 1;
			transform: translateX(0);
		}
	}
</style>
