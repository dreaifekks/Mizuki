---
import { Icon } from "astro-icon/components";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
---

<!-- There can't be a filter on parent element, or it will break `fixed` -->
<div class="back-to-top-wrapper block">
    <div
        id="post-language-floating-control"
        class="post-language-floating-control hide"
        data-post-variant-floating-root
        data-post-variant-i18n-default-label={i18n(I18nKey.postLanguageDefault)}
        aria-hidden="true"
    >
        <div class="post-language-floating-inner">
            <button
                type="button"
                aria-label={i18n(I18nKey.postLanguage)}
                aria-expanded="false"
                data-post-variant-floating-toggle
                class="btn-card h-[3.75rem] w-[3.75rem] rounded-2xl overflow-hidden post-language-floating-btn"
            >
                <Icon name="material-symbols:translate-rounded" class="mx-auto" />
            </button>

            <div class="post-language-floating-panel" data-post-variant-floating-panel>
                <div class="post-language-floating-title">{i18n(I18nKey.postLanguage)}</div>
                <div class="post-language-floating-current">
                    {i18n(I18nKey.postLanguageCurrent)}:
                    <span data-post-variant-current-label> {i18n(I18nKey.postLanguageNotSet)}</span>
                </div>
                <select
                    data-post-variant-floating-select
                    class="post-language-floating-select"
                    aria-label={i18n(I18nKey.postLanguage)}
                >
                    <option value="">{i18n(I18nKey.postLanguageNoOptions)}</option>
                </select>
            </div>
        </div>
    </div>

    <div id="back-to-top-btn" class="back-to-top-btn hide flex items-center rounded-2xl overflow-hidden transition"
         onclick="backToTop()">
        <button aria-label="Back to Top" class="btn-card h-[3.75rem] w-[3.75rem]">
            <Icon name="material-symbols:keyboard-arrow-up-rounded" class="mx-auto"></Icon>
        </button>
    </div>
</div>

<style lang="stylus">
  .back-to-top-wrapper
    width: 3.75rem
    height: 3.75rem
    position: absolute
    right: 0
    top: 0
    pointer-events: none

  .back-to-top-btn
    color: var(--primary)
    font-size: 2.25rem
    font-weight: bold
    border: none
    position: fixed
    bottom: 10rem
    opacity: 1
    right: 6rem
    cursor: pointer
    transform: translateX(5rem)
    pointer-events: auto
    transition: box-shadow 1s ease-in-out

    i
      font-size: 1.75rem

    &.hide
      transform: translateX(5rem) scale(0.9)
      opacity: 0
      pointer-events: none

    &:active
      transform: translateX(5rem) scale(0.9)

  .post-language-floating-control
    position: fixed
    bottom: 14.5rem
    right: 6rem
    z-index: 40
    transform: translateX(5rem)
    opacity: 1
    pointer-events: auto

    &.hide
      transform: translateX(5rem) scale(0.9)
      opacity: 0
      pointer-events: none

  .post-language-floating-inner
    position: relative
    display: flex
    align-items: center
    justify-content: center

  .post-language-floating-btn
    color: var(--primary)

    i
      font-size: 1.5rem

  .post-language-floating-panel
    position: absolute
    right: calc(100% + 0.75rem)
    bottom: 0
    width: 13rem
    padding: 0.75rem
    border-radius: var(--radius-large)
    border: 1px solid var(--line-divider)
    background: var(--card-bg-transparent)
    backdrop-filter: blur(12px)
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12)
    opacity: 0
    transform: translateX(0.5rem) scale(0.98)
    pointer-events: none
    transition: opacity 0.18s ease, transform 0.18s ease

    &::after
      // Bridge the hover gap between trigger button and panel
      content: ""
      position: absolute
      top: 0
      right: -0.75rem
      width: 0.75rem
      height: 100%

  .post-language-floating-control:hover .post-language-floating-panel,
  .post-language-floating-control:focus-within .post-language-floating-panel,
  .post-language-floating-control.panel-open .post-language-floating-panel
    opacity: 1
    transform: translateX(0) scale(1)
    pointer-events: auto

  .post-language-floating-title
    font-size: 0.8rem
    font-weight: 600
    color: var(--content-meta)
    margin-bottom: 0.35rem

  .post-language-floating-current
    font-size: 0.75rem
    color: var(--content-meta)
    margin-bottom: 0.5rem
    line-height: 1.3

  .post-language-floating-select
    width: 100%
    border-radius: calc(var(--radius-large) - 0.35rem)
    border: 1px solid var(--line-divider)
    background: var(--btn-regular-bg)
    color: inherit
    font-size: 0.85rem
    padding: 0.45rem 0.55rem
    outline: none

    &:focus
      border-color: var(--primary)
      box-shadow: 0 0 0 2px var(--line-divider)

  @media (max-width: 1560px)
    .back-to-top-btn
      box-shadow: none

    .post-language-floating-panel
      box-shadow: none

  // 手机端隐藏返回顶部按钮
  @media (max-width: 768px)
    .back-to-top-wrapper
      display: block

    .back-to-top-btn
      display: none

    .post-language-floating-control
      display: block
      right: 1rem
      bottom: 5.75rem
      z-index: 70
      transform: translateX(0)

      @supports (right: env(safe-area-inset-right))
        right: calc(1rem + env(safe-area-inset-right))
        bottom: calc(5.75rem + env(safe-area-inset-bottom))

      &.hide
        transform: translateX(1.5rem) scale(0.9)

    .post-language-floating-btn
      width: 3.25rem
      height: 3.25rem
      border-radius: 1rem
      touch-action: manipulation

      i
        font-size: 1.35rem

    .post-language-floating-panel
      right: 0
      bottom: calc(100% + 0.6rem)
      width: 13rem
      max-width: calc(100vw - 2rem)
      transform: translateY(0.5rem) scale(0.98)

      &::after
        top: auto
        right: 0
        bottom: -0.6rem
        width: 100%
        height: 0.6rem

    .post-language-floating-control:hover .post-language-floating-panel,
    .post-language-floating-control:focus-within .post-language-floating-panel,
    .post-language-floating-control.panel-open .post-language-floating-panel
      transform: translateY(0) scale(1)

</style>

<script is:raw is:inline>
    function backToTop() {
        // 直接使用原生滚动，避免OverlayScrollbars冲突
        window.scroll({top: 0, behavior: 'smooth'});
    }

    function setupPostVariantFloatingPanel() {
        if (window._mizukiPostVariantFloatingPanelBound) return;

        const root = document.querySelector('[data-post-variant-floating-root]');
        if (!root) return;

        const toggle = root.querySelector('[data-post-variant-floating-toggle]');
        const panel = root.querySelector('[data-post-variant-floating-panel]');
        const select = root.querySelector('[data-post-variant-floating-select]');
        if (!toggle || !panel) return;

        const closePanel = () => {
            root.classList.remove('panel-open');
            toggle.setAttribute('aria-expanded', 'false');
        };

        const openPanel = () => {
            root.classList.add('panel-open');
            toggle.setAttribute('aria-expanded', 'true');
        };

        toggle.addEventListener('click', (event) => {
            if (window.matchMedia('(max-width: 768px)').matches) {
                event.preventDefault();
                if (root.classList.contains('panel-open')) {
                    closePanel();
                } else {
                    openPanel();
                }
            }
        });

        document.addEventListener('click', (event) => {
            if (!root.contains(event.target)) {
                closePanel();
            }
        });

        if (select) {
            select.addEventListener('change', () => {
                if (window.matchMedia('(max-width: 768px)').matches) {
                    setTimeout(closePanel, 100);
                }
            });
        }

        window.addEventListener('resize', () => {
            if (!window.matchMedia('(max-width: 768px)').matches) {
                closePanel();
            }
        });

        window._mizukiPostVariantFloatingPanelClose = closePanel;
        window._mizukiPostVariantFloatingPanelBound = true;
    }

    document.addEventListener('DOMContentLoaded', setupPostVariantFloatingPanel);
    if (document.readyState !== 'loading') {
        setupPostVariantFloatingPanel();
    }
</script>
